# Работа с Дзен Мани через Google Таблицы

Данная серия скриптов предназначена для интеграции данных приложения Дзен Мани с Google Таблицами через экспорт и импорт транзакций, счетов и категорий.

# Как использовать
Создайте новый файл таблиц, или возьмите готовый [шаблон настроек](https://docs.google.com/spreadsheets/d/1tSTjqCeHK3t6BUOEQUnOXYQhDoTdJQWTZmOCuL_A1v4/edit?usp=sharing):

На листе Settings выставьте токен в ячейку B1 (можно получить через [Zerro.app](https://zerro.app/token)), а также названия используемых листов.

Зайдите в меню Extensions -> Apps Scrips, и последовательно скопируйте нужные вам скрипты через Files (+ Add a file) -> Script. Рекомендую начать с Settings, Main, Logs, Dictionaries и Export - в таком порядке. Порядок важен, Settings должнен идти первым в списке, затем Main, затем остальные.

Обновите файл таблиц. Если появилось меню Zenmoney, поздравляю, у вас получилось. Запустите любой пункт меню, чтобы появился запрос на предоставление скриптам необходимых прав, и подтвердите его. Запустите Zenmoney -> Full Sync, или же Zenmoney -> Export -> Update Dictionaries, чтобы обновить словари. Выберите пользователя и валюту по умолчанию на листе настроек. Вы готовы приступить к работе! 

Для работы используются:
* Скрипт [Settings](https://github.com/nevill-spb/zm2gs_Import/blob/main/Scripts/Settings.gs) с настройками остальных скриптов - обязателен
* Скрипт [Main](https://github.com/nevill-spb/zm2gs_Import/blob/main/Scripts/Main.gs) с описанием основных функций по синхронизации данных - обязателен
* Скрипт [Logs](https://github.com/nevill-spb/zm2gs_Import/blob/main/Scripts/Logs.gs) для логгирования - обязателен
* Скрипт [Dictionaries](https://github.com/nevill-spb/zm2gs_Import/blob/main/Scripts/Dictionaries.gs) - для операций со словарями. Необходим для экспорта, импорта, и работы со счетами.
* Скрипт [Export](https://github.com/nevill-spb/zm2gs_Import/blob/main/Scripts/Export.gs) - для экспорта транзакций с сервера в Google Таблицы
* Скрипт [Import](https://github.com/nevill-spb/zm2gs_Import/blob/main/Scripts/Import.gs) - для импорта транзакций на сервер из Google Таблиц
* Скрипт Changes - для автоматического отслеживания измененных транзакций на листе
* Скрипт Categories - для импорта и экспорта данных по категориям
* Скрипт Accounts - для импорта и экспорта данных по счетам
* Скрипт Merchants - для импорта и экспорта данных по местам

Экспорт данных в Google Таблицы относительно безопасен, скрипт просто забирает их с сервера и раскидывает по ячейкам. Запросы же на изменение данных выполняются уже на ваш страх и риск. Защита от дурака предусмотрена, но не покрывает все случаи, тем более, что полной документации на API я не видел.

Скрипт Main добавляет в Google Таблицы Меню Zenmoney, которое содержит следующие кнопки, в зависимости от установленных вами скриптов:
* Кнопка Full Sync (скрипт Main): последовательно вызывает скрипты синхронизации и экспорта транзакций, словарей, категорий, счетов и мест на отдельные листы.

Подменю Export (скрипт Export):
* Full Export: полный экспорт скачивает все доступные на сервере транзакции и записывает их на лист экспорта
* Incremental Export: инкрементальный экспорт скачивает изменения на сервере с последней синхронизации и применяет их к листу экспорта
* Prepare Changes Sheet: подготовка изменений скачивает изменения на сервере и записывает их в отдельный лист изменений
* Apply Changes to Data Sheet: применяет изменения с отдельного листа к листу экспорта
* Update Dictionaries: обновляет данные словарей и записывает их на отдельный лист

Подменю Import (скрипт Import):
* Full Import: полный импорт передает на сервер все операции с листа импорта, как новые
* Partial Import: инкрементальный импорт передает на сервер только новые операции, а также операции, отмеченные соответствующим чекбоксом
* Set Triggers (скрипт Changes): включает триггеры отслеживания изменений на листе импорта, выставляющие чекбокс при изменении существенных данных транзакции
* Delete Triggers (скрипт Changes): выключает триггеры отслеживания изменений на листе импорта

Подменю Categories (скрипт Categories):
* Load: экспорт категорий с сервера на отдельный лист
* Save: импорт категорий с отдельного листа на сервер

Подменю Accounts (скрипт Accounts):
* Load: экспорт счетов с сервера на отдельный лист
* Save: импорт счетов с отдельного листа на сервер

Подменю Merchants (скрипт Merchants):
* Load: экспорт мест с сервера на отдельный лист
* Save: импорт мест с отдельного листа на сервер

# Скрипт настроек

В нём задаются ячейки и листы, которые используют остальные скрипты. Откуда брать токен, какой лист использовать для экспорта или импорта. Большинство данных берётся с листа настроек, но есть также и те, которые нужно менять вручную. К ним относится порядок колонок на листе с данными, цвета для подсветки изменений при инкрементальном экспорте, размер пакета для импорта транзакций, и др.

Основное, что может вам понадобиться - это список валют, с которыми работает скрипт словарей. Всего в справочнике валют их 137, я не захотел иметь в словаре полторы сотни строк, из которых используется максимум три. Поэтому валюты задаются в скрипте вручную по коду. Просто допишите в ALLOWED_CURRENCY_CODES, например, GBP для работы с фунтами стерлингов.

Документация на остальное будет, когда я решу, что выносить в общие настройки, а что нет.

# Скрипт экспорта

Здесь всё относительно просто. Большинство потребностей удовлетворит кнопка Full Export. Транзакции стягиваются с сервера, и раскидываются по ячейкам листа экспорта, задаваемого в настройках. Перед этим данные конвертируется в понятный человеческому глазу формат через сопоставление id категорий, счетов и валют с их названиями. После успешного экспорта обновляется время последней синхронизации на листе настроек.

Инкрементальный экспорт забирает с сервера транзакции по методу DIFF, т.е. изменения за период, прошедший со времени последней синхронизации на листе настроек по текущий момент. Изменения выносятся на отдельный лист, откуда они затем применяются к документу. Обращаю внимание, что изменённые транзации уже находятся на сервере, и инкрементальный экспорт не сделает ничего, чего не мог бы сделать полный экспорт. Однако, он может быть полезен для отслеживания изменений, ведь "дату последней синхронизации" на листе настроек можно устанавливать вручную.

Возможно, более полезными будут отдельные функции, которые использует инкрементальный экспорт. "Подготовка листа изменений" записывает изменения на отдельный лист, и сравнивает их с листом данных. Удалённые транзакции помечаются красным; те, что удалены на сервере, но ещё не удалены на листе (т.е. недавно удалённые) - оранжевым; те, что есть на листе (существующие) - жёлтым, а те, что созданы на сервере, но ещё не получены - зелёным. Это поможет вам отследить, что поменяется при попытке синхронизации через Full Sync или Full Export. Подсветка изменений производится в зависимости от того, что у вас записано на листе данных. Если они получены не через экспорт транзакций с сервера, подсветка может ввести вас в заблуждение.

Функция "Применить изменения" делает то, что заявлено - переносит изменения в лист с экспортируемыми данными. Быстрее было бы воспользоваться полным экспортом, однако изменения можно модифицировать перед применением - например, для последующего импорта модификаций на сервер, если что-то в них вас не устраивает.

"Обновление словарей" - т.е. таблиц, где зашифрованный id объекта сопоставляется с отображаемым именем, - необходимо для задания пользователя и валюты по умолчанию на листе настроек, а также для корректного импорта. Обновлять словари следует перед каждой попыткой импорта (если были изменения хоть в чём-либо), т.к. данные на листе выводятся в читаемом формате, и для перевода их в формат Дзен Мани необходима обратное шифроввние. В дальнейшем я, вероятно, автоматизирую данный процесс, пусть он и отнимает секунд пять перед каждым импортом, ну а пока необходимо усвоить правило: перед тем, как что-либо импортировать, необходимо удостовериться, что вы разговариваете с сервером на одном языке.

# Скрипт импорта

Дзен Мани хранит данные в формате JSON, в виде нескольких словарей ('account', 'tag', 'merchant', 'transaction' для аккаунтов, категорий, мест и транзакций) с полями, описывающими объект. Все объекты используют UUID в качестве идентификатора. UUID уникальны, и не принимаются к повторному использованию. Это значит, что при удалении категории или счёта, состояние "как было" вернуть уже невозможно, а можно только завести новые объекты с теми же свойствами. Таким образом, даже если вы сохраните полный слепок данных на определённую дату, бэкап сопряжён с определёнными сложностями, если вы меняли и, в особенности, удаляли счета и категории. Самый простой способ восстановления - сбросить аккаунт до чистого состояния, и импортировать все объекты с чистого листа.

Скрипт импорта транзакций определяет транзакцию без UUID как новую, и автоматически помечает строку к импорту при наличии хотя бы трёх столбцов: даты, счёта расхода или дохода, и суммы расхода или дохода. Все остальные поля можно оставить пустыми - в этом случае они будут сгенерированы автоматически - или же заполнить данными в формате, принимаемом API.

Изменение существующих транзакций производится через установку флага "Изменено" в транзакции. Скрипт попытается передать ваши изменения на сервер. Какие-то из них принимаются без вопросов, какие-то нет. Я бы рекомендовал ограничиться изменением оригинальных полей (те, что доступны при экспорте из приложения или на сайте), но экспрериментировать не возбраняется. Только учтите, что некоторые изменения могут довести транзакцию до состояния, которое приложение прочитать уже не сможет.

Удаление существующих транзакций производится через установку обоих флагов "Удалено" и "Изменено". При этом у транзакции обязан быть ID, в противном случае флаг "Удалено" будет проигнорирован и снят, а транзакция обработается как новая. Удалённые транзакции не могут быть восстановлены через снятие флага "Удалено", их необходимо импортировать заново.

Во время импорта строка преобразовывает название счёта, категории и места в формат Дзен, которому нужны их UUID. Все они должны быть перечислены в листе словарей; если транзакцию не удаётся расшифровать, строчка не будет импортирована. Это оправдано в случае словарей счетов и категорий, которые представляют собой сложные объекты, но словарь мест практически не содержит данных, кроме id и названия места. Поэтому если строка ссылается на место, которого нет в словарях, это место импортируется в словарь "на ходу". Что удобно, но влечёт за собой появление дубликатов, если вы проводите импорт без предварительного обновления словарей.

Импорт производится кусками по 100 транзакций (задаётся в скрипте настроек) во избежание проблем с отправкой большого количества данных. При импорте большого количества транзакций логгирование рекомендуется отключать, т.к. оно существенно замедляет процесс. Время выполнения скрипта ограничено шестью минутами, примите это к сведению при единоразовом импорте огромных файлов. Есть успешный опыт импорта 4000 операций за раз, но в целом - проявляйте осторожность. Впрочем, даже если скрипт прервётся, ничего страшного не случится, все ранее импортированные операции останутся на сервере, и будут помечены как переданные. Проблема возникнет у последнего кусочка, который будет передан лишь частично, и никак не отразит это в таблице (т.к. эта часть выполняется после успешной передачи всего куска операций). Это решаемо.

Ошибки импорта, при наличии таковых, выносятся на отдельный лист, и не прерывают импорт. Постарался учесть наиболее частые, если импорт проваливается без видимых причин - опишите свой случай, буду расширять базу предупреждений. Все операции, импорт которых по какой-либо причине не удался, остаются отмеченными флагом "Изменено", и могут быть поправлены перед новой попыткой импорта. С операций, успешно прошедших импорт, флаг "Изменено" снимается.

После импорта транзакций на сервер рекомендуется сделать экспорт операций с сервера, чтобы убедиться, что операция прошла успешно. Автоматически этого не происходит потому, что вызов функции экспорта очищает поле "Изменено" и сбрасывает любые изменения в файле данных, которые не были переданы на сервер.
